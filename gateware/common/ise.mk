PROJECT ?= top
TOP ?= ${PROJECT}
TOP_MODULE ?= ${TOP}
TOP_SOURCE ?= ${TOP}.v
ADDITIONAL_SOURCES ?=
VERILOG_DEFINES ?= # VARIABLE1=VALUE1 VARIABLE2=VALUE2

PART ?= # xc3s200a-ft256-4
FAMILY ?= # spartan3a
UCF ?= ${PROJECT}.ucf

BITSTREAM ?= ${PROJECT}.bit

ifeq ($(TOOLCHAIN),ise)
.PHONY: all
all: ${BITSTREAM}

PLANAHEAD_PROJECT = pa_${PROJECT}

# Assumes verilog project
${PROJECT}.PlanAhead.tcl: ${TOP_SOURCE} ${ADDITIONAL_SOURCES} ${UCF}
	echo "# PlanAhead script generated by ise.mk/Makefile" > $@
	echo "create_project -part ${PART} -force ${PLANAHEAD_PROJECT}" >> $@
	echo "set_property design_mode RTL [get_property srcset [current_run]]" >> $@
	echo "set_property target_language Verilog [current_project]" >> $@
	echo "read_verilog -library work ${TOP_SOURCE} ${ADDITIONAL_SOURCES}" >> $@
	echo "read_ucf ${UCF}" >> $@
	echo "set_property top ${TOP_MODULE} [get_property srcset [current_run]]" >> $@
	echo "set_property verilog_define {${VERILOG_DEFINES}} [get_property srcset [current_run]]" >> $@
	echo "launch_runs synth_1" >> $@
	echo "wait_on_run synth_1" >> $@
	echo "launch_runs -to_step Bitgen impl_1" >> $@
	echo "wait_on_run impl_1" >> $@

${PLANAHEAD_PROJECT}.runs/impl_1/${TOP}.bit: ${PROJECT}.PlanAhead.tcl
	planAhead -mode batch -source $<
	rm $<

${BITSTREAM}: ${PLANAHEAD_PROJECT}.runs/impl_1/${TOP}.bit
	cp $< $@

.PHONY: clean
clean::
	-@rm -f ${PROJECT}.PlanAhead.tcl
	-@rm -f pa_${PROJECT}.ppr
	-@rm -rf pa_${PROJECT}.runs
	-@rm -rf pa_${PROJECT}.data
	-@rm -rf planAhead_run_*
	-@rm -rf ipcore_dir
	-@rm -rf iseconfig
	-@rm -rf _ngo
	-@rm -rf _xmsgs
	-@rm -rf xst
	-@rm -f ${BITSTREAM}
	-@rm -f *.jou
	-@rm -f *.html
	-@rm -f *.xml
	-@rm -f *.log *.cmd_log
	-@rm -f *.debug
	-@rm -f *.gise *.xise
	-@rm -f ${PROJECT}_pad.csv ${PROJECT}_pad.txt
	-@rm -f *.bgn *.bld *.drc *.ipf *.jed *.lso *.map *.mrp \
		*.ncd *.ngc *.ngd *.ngm *.ngr *.pad *.par *.pcf \
		*.prj *.ptwx *.stx *.syr *.twr *.twx *.unroutes \
		*.ut *.xdl *.xpi *.xrpt *.xst *.xwbt
endif
